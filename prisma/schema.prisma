// This is your Prisma schema file
// Matches the actual PostgreSQL database schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum RoleEnum {
  staff
  manager
  finance
  admin

  @@map("role_enum")
}

enum ExpenseStatusEnum {
  draft
  submitted
  approved
  rejected
  cancelled

  @@map("expense_status_enum")
}

enum ApprovalStatusEnum {
  pending
  approved
  rejected
  skipped

  @@map("approval_status_enum")
}

enum TagTypeEnum {
  collection
  campaign
  custom
  department

  @@map("tag_type_enum")
}

// ==========================================
// USER MANAGEMENT
// ==========================================

model User {
  userId    String   @id @default(dbgenerated("gen_random_uuid()")) @map("user_id") @db.Uuid
  name      String
  email     String   @unique
  password  String
  role      RoleEnum @default(staff)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  expenses      Expense[]
  approvals     Approval[]
  rewards       Reward[]
  auditLogs     AuditLog[]

  @@map("users")
}

// ==========================================
// VENDOR MANAGEMENT
// ==========================================

model Vendor {
  vendorId  String   @id @default(dbgenerated("gen_random_uuid()")) @map("vendor_id") @db.Uuid
  name      String
  gstNumber String?  @map("gst_number")
  email     String?
  phone     String?
  address   String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  expenses        Expense[]
  purchaseOrders  PurchaseOrder[]

  @@map("vendors")
}

// ==========================================
// CATEGORIZATION
// ==========================================

model Category {
  categoryId  String   @id @default(dbgenerated("gen_random_uuid()")) @map("category_id") @db.Uuid
  name        String   @unique
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  expenses      Expense[]
  approvalRules ApprovalRule[]
  budgets       Budget[]
  predictions   Prediction[]

  @@map("categories")
}

model Department {
  departmentId String   @id @default(dbgenerated("gen_random_uuid()")) @map("department_id") @db.Uuid
  name         String   @unique
  code         String?  @unique
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  expenses    Expense[]
  budgets     Budget[]
  predictions Prediction[]

  @@map("departments")
}

// ==========================================
// TAGGING SYSTEM
// ==========================================

model Tag {
  tagId     String      @id @default(dbgenerated("gen_random_uuid()")) @map("tag_id") @db.Uuid
  name      String
  type      TagTypeEnum
  isActive  Boolean     @default(true) @map("is_active")
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  expenseTags ExpenseTag[]

  @@unique([name, type])
  @@map("tags")
}

// ==========================================
// EXPENSE MANAGEMENT
// ==========================================

model Expense {
  expenseId       String            @id @default(dbgenerated("gen_random_uuid()")) @map("expense_id") @db.Uuid
  userId          String            @map("user_id") @db.Uuid
  vendorId        String            @map("vendor_id") @db.Uuid
  categoryId      String            @map("category_id") @db.Uuid
  departmentId    String            @map("department_id") @db.Uuid
  description     String
  amountNet       Decimal           @map("amount_net") @db.Decimal(12, 2)
  taxAmount       Decimal           @map("tax_amount") @db.Decimal(12, 2)
  totalAmount     Decimal           @map("total_amount") @db.Decimal(12, 2)
  status          ExpenseStatusEnum @default(draft)
  receiptUrl      String?           @map("receipt_url")
  dateOfExpense   DateTime          @map("date_of_expense") @db.Timestamptz(6)
  linkedPoId      String?           @map("linked_po_id") @db.Uuid
  inventoryDropId String?           @map("inventory_drop_id") @db.Uuid
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user          User            @relation(fields: [userId], references: [userId])
  vendor        Vendor          @relation(fields: [vendorId], references: [vendorId])
  category      Category        @relation(fields: [categoryId], references: [categoryId])
  department    Department      @relation(fields: [departmentId], references: [departmentId])
  purchaseOrder PurchaseOrder?  @relation(fields: [linkedPoId], references: [poId])
  inventoryDrop InventoryDrop?  @relation(fields: [inventoryDropId], references: [dropId])
  expenseTags   ExpenseTag[]
  approvals     Approval[]

  @@map("expenses")
}

model ExpenseTag {
  expenseId String   @map("expense_id") @db.Uuid
  tagId     String   @map("tag_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  expense Expense @relation(fields: [expenseId], references: [expenseId], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [tagId], onDelete: Cascade)

  @@id([expenseId, tagId])
  @@map("expense_tags")
}

// ==========================================
// APPROVAL SYSTEM
// ==========================================

model ApprovalRule {
  ruleId        String   @id @default(dbgenerated("gen_random_uuid()")) @map("rule_id") @db.Uuid
  categoryId    String   @map("category_id") @db.Uuid
  minAmount     Decimal  @map("min_amount") @db.Decimal(12, 2)
  approverRole  String   @map("approver_role")
  approvalOrder Int      @map("approval_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  category Category @relation(fields: [categoryId], references: [categoryId])

  @@map("approval_rules")
}

model Approval {
  approvalId String              @id @default(dbgenerated("gen_random_uuid()")) @map("approval_id") @db.Uuid
  expenseId  String              @map("expense_id") @db.Uuid
  approverId String              @map("approver_id") @db.Uuid
  status     ApprovalStatusEnum  @default(pending)
  comments   String?
  approvedAt DateTime?           @map("approved_at") @db.Timestamptz(6)
  createdAt  DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  expense  Expense @relation(fields: [expenseId], references: [expenseId], onDelete: Cascade)
  approver User    @relation(fields: [approverId], references: [userId])

  @@map("approvals")
}

// ==========================================
// BUDGET MANAGEMENT
// ==========================================

model Budget {
  budgetId     String   @id @default(dbgenerated("gen_random_uuid()")) @map("budget_id") @db.Uuid
  departmentId String   @map("department_id") @db.Uuid
  categoryId   String   @map("category_id") @db.Uuid
  budgetAmount Decimal  @map("budget_amount") @db.Decimal(12, 2)
  spentAmount  Decimal  @default(0) @map("spent_amount") @db.Decimal(12, 2)
  fiscalPeriod String   @map("fiscal_period")
  startDate    DateTime @map("start_date") @db.Timestamptz(6)
  endDate      DateTime @map("end_date") @db.Timestamptz(6)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  department Department @relation(fields: [departmentId], references: [departmentId])
  category   Category   @relation(fields: [categoryId], references: [categoryId])

  @@unique([departmentId, categoryId, fiscalPeriod])
  @@map("budgets")
}

// ==========================================
// PURCHASE ORDER MANAGEMENT
// ==========================================

model PurchaseOrder {
  poId        String   @id @default(dbgenerated("gen_random_uuid()")) @map("po_id") @db.Uuid
  poNumber    String   @unique @map("po_number")
  vendorId    String   @map("vendor_id") @db.Uuid
  totalValue  Decimal  @map("total_value") @db.Decimal(12, 2)
  status      String
  description String?
  issuedDate  DateTime @map("issued_date") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  vendor   Vendor    @relation(fields: [vendorId], references: [vendorId])
  expenses Expense[]

  @@map("purchase_orders")
}

// ==========================================
// INVENTORY MANAGEMENT
// ==========================================

model InventoryDrop {
  dropId     String   @id @default(dbgenerated("gen_random_uuid()")) @map("drop_id") @db.Uuid
  dropNumber String   @unique @map("drop_number")
  fabricType String   @map("fabric_type")
  quantity   Decimal  @db.Decimal(12, 3)
  unitCost   Decimal  @map("unit_cost") @db.Decimal(12, 2)
  totalCost  Decimal  @map("total_cost") @db.Decimal(12, 2)
  receivedOn DateTime @map("received_on") @db.Timestamptz(6)
  supplier   String?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  expenses Expense[]

  @@map("inventory_drops")
}

// ==========================================
// ANALYTICS & PREDICTIONS
// ==========================================

model Prediction {
  predictionId   String   @id @default(dbgenerated("gen_random_uuid()")) @map("prediction_id") @db.Uuid
  departmentId   String   @map("department_id") @db.Uuid
  categoryId     String   @map("category_id") @db.Uuid
  predictedMonth DateTime @map("predicted_month") @db.Timestamptz(6)
  expectedSpend  Decimal  @map("expected_spend") @db.Decimal(12, 2)
  confidence     Float?
  actualSpend    Decimal? @map("actual_spend") @db.Decimal(12, 2)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  department Department @relation(fields: [departmentId], references: [departmentId])
  category   Category   @relation(fields: [categoryId], references: [categoryId])

  @@map("predictions")
}

// ==========================================
// GAMIFICATION
// ==========================================

model Reward {
  rewardId      String   @id @default(dbgenerated("gen_random_uuid()")) @map("reward_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  type          String
  pointsAwarded Int      @map("points_awarded")
  reason        String?
  earnedOn      DateTime @map("earned_on") @db.Timestamptz(6)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [userId])

  @@map("rewards")
}

// ==========================================
// AUDIT & COMPLIANCE
// ==========================================

model AuditLog {
  auditId     String   @id @default(dbgenerated("gen_random_uuid()")) @map("audit_id") @db.Uuid
  action      String
  actorId     String   @map("actor_id") @db.Uuid
  targetType  String   @map("target_type")
  targetId    String   @map("target_id") @db.Uuid
  timestamp   DateTime @default(now()) @db.Timestamptz(6)
  description String?
  metadata    Json?    @db.JsonB
  ipAddress   String?  @map("ip_address")

  // Relations
  actor User @relation(fields: [actorId], references: [userId])

  @@map("audit_logs")
}
